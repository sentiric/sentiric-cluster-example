# docker-compose.zone_c.yml

networks:
  sentiric-net:
    name: "${NETWORK_NAME:-sentiric-net}"
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET}
          gateway: ${NETWORK_GATEWAY}

volumes:
  # [backbone]: Omurga Servisleri (Backbone Layer)
  # --------------------------------------------------
  discovery_data:


services:
  discovery-service:
    image: ghcr.io/sentiric/sentiric-discovery:latest
    env_file: [ "${ENV_FILE_PATH}" ]
    volumes:
      - discovery_data:/consul/data
      - ./discovery/config/zone_c:/consul/config
    ports:
      # Bu portlar Tailscale ağı üzerinden iletişimi sağlayacak.
      - "${DISCOVERY_SERVICE_RPC_PORT:-8300}:${DISCOVERY_SERVICE_RPC_PORT:-8300}" # Server RPC (Remote Procedure Call) portudur.
      - "${DISCOVERY_SERVICE_LAN_PORT:-8301}:${DISCOVERY_SERVICE_LAN_PORT:-8301}/tcp" # Küme içi Agent iletişimi (Gossip - LAN) (TCP)
      - "${DISCOVERY_SERVICE_LAN_PORT:-8301}:${DISCOVERY_SERVICE_LAN_PORT:-8301}/udp" # Küme içi Agent iletişimi (Gossip - LAN) (UDP)
      - "${DISCOVERY_SERVICE_WAN_PORT:-8302}:${DISCOVERY_SERVICE_WAN_PORT:-8302}/tcp" # Veri merkezleri arası Sunucu iletişimi (Gossip - WAN) (TCP)
      - "${DISCOVERY_SERVICE_WAN_PORT:-8302}:${DISCOVERY_SERVICE_WAN_PORT:-8302}/udp" # Veri merkezleri arası Sunucu iletişimi (Gossip - WAN) (UDP)
      - "${DISCOVERY_SERVICE_HTTP_PORT:-8500}:8500" # Discovery UI & HTTP API
      - "${DISCOVERY_SERVICE_DNS_PORT:-8600}:8600/tcp" # Discovery DNS Arayüzü (TCP)
      - "${DISCOVERY_SERVICE_DNS_PORT:-8600}:8600/udp" # Discovery DNS Arayüzü (UDP)
    networks:
      sentiric-net:
        ipv4_address: ${DISCOVERY_SERVICE_IPV4_ADDRESS}
    command: >
      agent -server -bootstrap-expect=3 -ui  
      -node=${ZONE_C_HOSTNAME}  
      -advertise='${ZONE_C_BACKBONE_IP}'  
      -retry-join='${ZONE_A_BACKBONE_IP}'  
      -retry-join='${ZONE_B_BACKBONE_IP}'        
      -datacenter=${DISCOVERY_DATACENTER_NAME}
      -domain=${DISCOVERY_DOMAIN}
      -client=0.0.0.0  
      -bind=0.0.0.0  
      -disable-host-node-id  
      -config-dir=/consul/config
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
    restart: always
    healthcheck:
      # Sadece Consul agent'ının ayakta ve API'sinin cevap verir durumda olduğunu
      # kontrol ediyoruz. Bu, küme kurulmadan veya lider seçilmeden önce de çalışır.
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:8500/v1/agent/self"]
      interval: 10s
      timeout: 5s
      retries: 10

  # [capability-telephony]: Yetenek Servisleri (Capability Layer)
  # --------------------------------------------------    
  sip-signaling:
    build: { context: services/sip-signaling }
    env_file: [ "${ENV_FILE_PATH}" ]   
    ports:
      - "${SIP_SIGNALING_HTTP_PORT:-13020}:${SIP_SIGNALING_HTTP_PORT:-13020}"
      - "${SIP_SIGNALING_GRPC_PORT:-13021}:${SIP_SIGNALING_GRPC_PORT:-13021}"
      - "${SIP_SIGNALING_METRICS_PORT:-13022}:${SIP_SIGNALING_METRICS_PORT:-13022}"
      - "${SIP_SIGNALING_WS_PORT:-13023}:${SIP_SIGNALING_WS_PORT:-13023}"
      - "${SIP_SIGNALING_UDP_PORT:-13024}:${SIP_SIGNALING_UDP_PORT:-13024}/udp"
    networks:
      sentiric-net:
        ipv4_address: ${SIP_SIGNALING_IPV4_ADDRESS}       
    restart: always
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -sf http://127.0.0.1:13020/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    # depends_on: # sip-signaling servisinin başlamak için discovery-service'in "healthy" olmasını beklemesine gerek yoktur
    #   discovery-service: { condition: service_healthy }
